<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>Калькулятор трудозатрат по конфигурированию</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg: #f8fafc;
      --fg: #0f172a;
      --muted: #64748b;
      --card: #ffffff;
      --border: #e2e8f0;
      --accent: #0ea5e9;
      --accent-soft: #e0f2fe;
      --danger: #dc2626;
      --warn: #d97706;
      --ok: #059669;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    h1, h2, h3, h4 {
      margin: 0 0 0.5rem 0;
      font-weight: 600;
    }
    p {
      margin: 0 0 0.5rem 0;
    }
    .page {
      max-width: 1360px;
      margin: 0 auto;
      padding: 16px 16px 32px;
    }
    .page-header {
      margin-bottom: 16px;
      padding: 16px 20px;
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .page-header h1 {
      font-size: 22px;
      margin-bottom: 4px;
    }
    .page-header p {
      font-size: 13px;
      color: var(--muted);
    }
    .section {
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 12px 16px 16px;
      margin-bottom: 12px;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .section-header h2 {
      font-size: 15px;
      margin: 0;
    }
    .section-header small {
      color: var(--muted);
      font-size: 11px;
    }
    .section-toggle {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f1f5f9;
      cursor: pointer;
    }
    .section-toggle:hover {
      background: #e2e8f0;
    }
    .section-body {
      margin-top: 4px;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .field {
      flex: 1 1 200px;
      min-width: 160px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .field label {
      font-size: 11px;
      color: var(--muted);
    }
    .field input,
    .field select,
    .field textarea {
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: #f8fafc;
      outline: none;
    }
    .field textarea {
      resize: vertical;
      min-height: 60px;
    }
    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: var(--accent);
      background: #ffffff;
    }
    input[disabled],
    select[disabled],
    button[disabled],
    textarea[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .button-primary,
    .button-secondary,
    .button-ghost,
    .button-danger {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      background: #e5e7eb;
    }
    .button-primary {
      background: var(--accent);
      color: #0b1120;
      border-color: #0ea5e9;
    }
    .button-primary:hover {
      background: #38bdf8;
    }
    .button-secondary {
      background: #f1f5f9;
      border-color: var(--border);
      color: #0f172a;
    }
    .button-secondary:hover {
      background: #e2e8f0;
    }
    .button-ghost {
      background: transparent;
      border-color: var(--border);
      color: var(--muted);
    }
    .button-ghost:hover {
      background: #f8fafc;
    }
    .button-danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }
    .button-danger:hover {
      background: #fecaca;
    }
    .button-sm {
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 999px;
    }

    .upload-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .method-layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      align-items: start;
    }

    .method-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #e2e8f0;
      color: #0f172a;
      font-weight: 700;
      font-size: 12px;
      cursor: default;
      position: relative;
    }

    .tooltip-icon::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: #0f172a;
      color: #f8fafc;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 11px;
      width: 240px;
      max-width: 280px;
      text-align: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
      z-index: 5;
    }

    .tooltip-icon:hover::after {
      opacity: 1;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 8px;
    }
    .section-card {
      position: relative;
      border-radius: 10px;
      padding: 10px 12px 12px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, #e0f2fe, #f9fafb);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 180px;
    }
    .section-card-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      text-align: center;
    }
    .section-card-title {
      font-size: 13px;
      font-weight: 600;
      width: 100%;
    }
    .section-card-meta {
      font-size: 11px;
      color: var(--muted);
      text-align: left;
      width: 100%;
    }
    .section-card-meta div {
      white-space: nowrap;
    }
    .section-card-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: auto;
      height: 100%;
    }
    .section-card-flags {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
    }
    .section-card-flags label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .section-card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }
    .empty-badge {
      display: inline-block;
      background: #fef9c3;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      color: #854d0e;
      border: 1px solid #facc15;
      margin-top: 2px;
    }

    .table-wrapper {
      border-radius: 8px;
      border: 1px solid var(--border);
      overflow: auto;
      max-height: 520px;
      background: #ffffff;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 11px;
      min-width: 980px;
    }
    thead {
      position: sticky;
      top: 0;
      background: #e5f2ff;
      z-index: 1;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 4px 6px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      font-weight: 600;
      font-size: 11px;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    tbody tr:hover {
      background: #eff6ff;
    }
    .cell-number {
      text-align: right;
      white-space: nowrap;
    }
    .cell-actions {
      white-space: nowrap;
    }
    .cell-muted {
      color: var(--muted);
    }
    .tag-flag {
      display: inline-block;
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 999px;
      border: 1px solid #94a3b8;
      color: #475569;
      background: #e2e8f0;
      margin-left: 4px;
    }

    .totals-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .total-card {
      flex: 1 1 160px;
      min-width: 140px;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 96px;
    }
    .total-card-label {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }
    .total-card-value {
      font-size: 18px;
      font-weight: 700;
      margin-top: 6px;
      display: flex;
      justify-content: center;
      align-items: baseline;
      gap: 6px;
    }
    .total-card-unit {
      font-size: 11px;
      color: var(--muted);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }
    .controls-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .controls-group-label {
      font-size: 11px;
      color: var(--muted);
      margin-right: 4px;
    }

    .collapse-toggle-row {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 4px;
    }

    .muted {
      color: var(--muted);
    }
    .text-danger {
      color: var(--danger);
    }
    .text-warn {
      color: var(--warn);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 10px;
      color: var(--muted);
      background: #f8fafc;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid var(--border);
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .modal-header h3 {
      font-size: 14px;
      margin: 0;
    }
    .modal-body {
      padding: 8px 12px 10px;
      overflow: auto;
      font-size: 12px;
    }
    .modal-footer {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .formula-block {
      font-size: 11px;
      background: #f1f5f9;
      border-radius: 6px;
      border: 1px dashed var(--border);
      padding: 6px 8px;
      margin-top: 4px;
      white-space: pre-line;
    }

    .warning-block {
      font-size: 11px;
      background: #fef3c7;
      border-radius: 6px;
      border: 1px solid #facc15;
      padding: 6px 8px;
      margin-top: 4px;
      color: #854d0e;
    }

    .toggle-switch {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    .toggle-switch input {
      margin: 0;
    }

    .hidden {
      display: none !important;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 10px;
      color: var(--muted);
    }

    .extras-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      align-items: stretch;
    }
    .extra-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #ffffff;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }

    .action-icon {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      padding: 4px 6px;
      border-radius: 6px;
    }
    .action-icon:hover {
      background: #e2e8f0;
    }

    .group-header-row td {
      font-weight: 700;
      font-size: 11px;
    }

    .compressed-table table {
      min-width: auto;
      table-layout: fixed;
    }

    .compressed-table th,
    .compressed-table td {
      white-space: normal;
    }

    .section-card.inactive {
      opacity: 0.65;
      filter: grayscale(0.2);
    }
    .section-card.inactive .button-primary {
      opacity: 0.8;
    }

    .section-card-meta .stat-line {
      display: flex;
      gap: 4px;
      justify-content: flex-start;
    }
    .section-card-meta .stat-line span:first-child {
      color: var(--muted);
    }

    .section-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
  </style>
</head>
<body>
<div class="page">
  <header class="page-header">
    <h1>Калькулятор трудозатрат по конфигурированию</h1>
    <p>Одностраничный калькулятор трудоёмкости конфигурирования по методике, загружаемой из Excel-файла. Все расчёты выполняются локально в браузере, без серверной части.</p>
  </header>

  <!-- Реквизиты проекта -->
  <section class="section" id="project-section">
    <div class="section-header">
      <div>
        <h2 id="projectTitle">Реквизиты проекта</h2>
        <small>Общая информация о расчёте</small>
      </div>
      <button type="button" class="section-toggle" id="toggleProjectMetaBtn">Свернуть</button>
    </div>
    <div class="section-body" id="projectMetaBody">
      <div class="field-row">
        <div class="field">
          <label for="projectName">Название проекта</label>
          <input id="projectName" type="text" placeholder="Например: Внедрение платформы Эталон в регионе"/>
        </div>
        <div class="field">
          <label for="calcDate">Дата расчёта</label>
          <input id="calcDate" type="date"/>
        </div>
        <div class="field">
          <label for="calcVersion">Версия расчёта</label>
          <input id="calcVersion" type="text" placeholder="v1.0"/>
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label for="executor">Исполнитель</label>
          <input id="executor" type="text" placeholder="ФИО / команда"/>
        </div>
        <div class="field">
          <label for="customer">Потенциальный заказчик</label>
          <input id="customer" type="text" placeholder="Организация / подразделение"/>
        </div>
      </div>
    </div>
  </section>

  <!-- Загрузка методики -->
  <section class="section" id="methodSection">
    <div class="section-header">
      <div>
        <h2 id="methodTitle">Загрузка методики (Excel)</h2>
        <small>Главный запуск работы калькулятора</small>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="badge" id="methodStatusBadge">Методика не загружена</span>
        <button type="button" class="section-toggle" id="toggleMethodSectionBtn">Свернуть</button>
      </div>
    </div>
    <div class="section-body" id="methodSectionBody">
      <div class="method-layout">
        <div class="method-box">
          <div class="field">
            <label for="excelInput">Файл методики (.xlsx)</label>
            <input id="excelInput" type="file" accept=".xlsx"/>
            <div class="upload-hint">
              После загрузки Excel методика и все элементы калькулятора будут сформированы автоматически.<br/>
              Обязательные столбцы: group_code, group_name, element_code, ..., short_description.
            </div>
            <div class="upload-hint" id="methodSuccessHint" style="margin-top:6px;color:var(--ok);display:none;">Файл успешно загружен.</div>
          </div>
        </div>
        <div class="method-box">
          <button type="button" class="button-secondary" id="openMethodologyBtn" disabled>Исходные данные методики</button>
          <div class="field" style="max-width:280px;">
            <label for="kPlatformInput" data-label-base="Коэффициент платформы" data-label-code="K_platform">Коэффициент платформы (K_platform)</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input id="kPlatformInput" type="number" step="0.01" value="1" disabled style="flex:1 1 auto;"/>
              <span class="tooltip-icon" data-tooltip="K_platform — коэффициент платформы. Масштабирует итоговую трудоёмкость проекта.">?</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Карточки разделов конфигурирования -->
  <section class="section">
    <div class="section-header">
      <div>
        <h2>Разделы конфигурирования</h2>
        <small>Карточки разделов формируются по данным методики после загрузки Excel</small>
      </div>
      <span class="badge" id="sectionsSummaryBadge">Разделы: 0</span>
    </div>
    <div class="section-body">
      <div class="cards-grid" id="sectionsContainer">
        <!-- Карточки создаются динамически -->
      </div>
      <div id="noSectionsHint" class="upload-hint">
        После загрузки Excel здесь появятся цветные карточки разделов (group_name) с краткой статистикой по каждому разделу.
      </div>
    </div>
  </section>

  <!-- Таблица расчётов -->
  <section class="section">
    <div class="section-header">
      <div>
        <h2>Таблица расчётов</h2>
        <small>Строки добавляются через карточки разделов и модальное окно элемента</small>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <button type="button" class="button-primary button-sm" id="addRowFromHeaderBtn" title="Добавить элемент">➕</button>
        <span class="badge" id="rowsSummaryBadge">Строк: 0</span>
      </div>
    </div>
    <div class="section-body">
      <label class="toggle-switch" style="margin-bottom:6px;">
        <input type="checkbox" id="collapseCalcTable" checked>
        <span>Сжать таблицу по ширине</span>
      </label>
      <div class="table-wrapper" id="calcTableWrapper">
        <table id="calcTable">
          <thead>
          <tr>
            <th>№</th>
            <th>Раздел</th>
            <th>Элемент (код + имя)</th>
            <th data-label-base="Трудоёмкость конфигурирования (базовое)" data-label-code="CFG"><span class="label-text">CFG базовое</span><br/><span class="muted">коэффициент / трудоёмкость (часы)</span></th>
            <th data-label-base="Анализ и проектирование (коэффициент)" data-label-code="ANDS"><span class="label-text">k_ANDS</span><br/><span class="muted">коэффициент / трудоёмкость (часы)</span></th>
            <th data-label-base="Тестирование (коэффициент)" data-label-code="TEST"><span class="label-text">k_TEST</span><br/><span class="muted">коэффициент / трудоёмкость (часы)</span></th>
            <th data-label-base="Документирование (коэффициент)" data-label-code="DOC"><span class="label-text">k_DOC</span><br/><span class="muted">коэффициент / трудоёмкость (часы)</span></th>
            <th data-label-base="Итоговый коэффициент по элементу" data-label-code="k_i"><span class="label-text">k_i</span><br/><span class="muted">коэффициент</span></th>
            <th>Кол-во</th>
            <th data-label-base="Трудоёмкость конфигурирования (итог без коэффициента платформы)" data-label-code="CFG"><span class="label-text">CFG итог TOTAL<br/>(без K_platform)</span><br/><span class="muted">трудоёмкость (часы)</span></th>
            <th data-label-base="Трудоёмкость конфигурирования" data-label-code="CFG"><span class="label-text">CFG фаза</span><br/><span class="muted">трудоёмкость (часы)</span></th>
            <th data-label-base="Анализ и проектирование" data-label-code="ANDS"><span class="label-text">ANDS фаза</span><br/><span class="muted">трудоёмкость (часы)</span></th>
            <th data-label-base="Тестирование" data-label-code="TEST"><span class="label-text">TEST фаза</span><br/><span class="muted">трудоёмкость (часы)</span></th>
            <th data-label-base="Документирование" data-label-code="DOC"><span class="label-text">DOC фаза</span><br/><span class="muted">трудоёмкость (часы)</span></th>
            <th>Комментарий</th>
            <th>Действия</th>
          </tr>
          </thead>
          <tbody id="calcTableBody">
          <!-- Строки создаются динамически -->
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Итоги по проекту -->
  <section class="section">
    <div class="section-header">
      <div>
        <h2>Итоги по проекту</h2>
        <small>Сводные значения CFG, ANDS, TEST, DOC и TOTAL</small>
      </div>
    </div>
    <div class="section-body">
      <div class="totals-row">
        <div class="total-card">
          <div class="total-card-label" id="totalCfgLabel">CFG (суммарно по элементам)</div>
          <div class="total-card-value"><span id="totalCfg">0</span><span class="total-card-unit">часы</span></div>
        </div>
        <div class="total-card">
          <div class="total-card-label" id="totalAndsLabel">ANDS</div>
          <div class="total-card-value"><span id="totalAnds">0</span><span class="total-card-unit">часы</span></div>
        </div>
        <div class="total-card">
          <div class="total-card-label" id="totalTestLabel">TEST</div>
          <div class="total-card-value"><span id="totalTest">0</span><span class="total-card-unit">часы</span></div>
        </div>
        <div class="total-card">
          <div class="total-card-label" id="totalDocLabel">DOC</div>
          <div class="total-card-value"><span id="totalDoc">0</span><span class="total-card-unit">часы</span></div>
        </div>
        <div class="total-card">
          <div class="total-card-label" id="totalOverallLabel">TOTAL (с учётом K_platform)</div>
          <div class="total-card-value"><span id="totalOverall">0</span><span class="total-card-unit">часы</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Дополнительные функции -->
  <section class="section">
    <div class="section-header">
      <div>
        <h2>Дополнительные функции</h2>
        <small>Отображение, экспорт/импорт, снапшоты</small>
      </div>
      <button type="button" class="section-toggle" id="toggleExtrasBtn">Свернуть</button>
    </div>
    <div class="section-body" id="extrasBody">
      <div class="extras-grid">
        <div class="extra-card">
          <label class="toggle-switch" style="gap:8px;">
            <input type="checkbox" id="toggleShowCodes" disabled/>
            <span>Показывать коды элементов</span>
          </label>
        </div>
        <div class="extra-card">
          <button type="button" class="button-secondary" id="exportDetailCsvBtn" disabled style="width:100%;">Экспорт CSV</button>
        </div>
        <div class="extra-card">
          <button type="button" class="button-secondary" id="saveSnapshotBtn" disabled style="width:100%;">Сохранить снапшот</button>
        </div>
        <div class="extra-card">
          <button type="button" class="button-secondary" id="loadSnapshotBtn" disabled style="width:100%;">Загрузить снапшот</button>
          <input type="file" id="snapshotFileInput" accept=".json" style="display:none;"/>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Модальное окно: элемент раздела -->
<div class="modal-backdrop" id="elementModalBackdrop">
  <div class="modal" style="max-width:960px;">
    <div class="modal-header">
      <h3>Элемент раздела</h3>
      <button type="button" class="button-ghost button-sm" id="closeElementModalBtn">Закрыть</button>
    </div>
    <div class="modal-body">
      <div class="field-row">
        <div class="field">
          <label for="elementSectionSelect">Раздел</label>
          <select id="elementSectionSelect"></select>
        </div>
        <div class="field">
          <label for="elementTypeSelect">Тип элемента (из методики)</label>
          <select id="elementTypeSelect"></select>
        </div>
        <div class="field">
          <label for="elementNameInput">Название элемента</label>
          <input id="elementNameInput" type="text" placeholder="По умолчанию из методики"/>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="elementQtyInput">Количество (шт.)</label>
          <input id="elementQtyInput" type="number" min="1" step="1" value="1"/>
        </div>
        <div class="field">
          <label for="cfgBaseInput" data-label-base="Трудоёмкость конфигурирования" data-label-code="CFG">Трудоёмкость конфигурирования (CFG) базовое</label>
          <input id="cfgBaseInput" type="number" step="0.001"/>
        </div>
        <div class="field">
          <label for="valueInput">Параметр value (приращение)</label>
          <input id="valueInput" type="number" step="0.001" value="0"/>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="kAndsInput" data-label-base="Анализ и проектирование" data-label-code="ANDS">Анализ и проектирование (ANDS)</label>
          <input id="kAndsInput" type="number" step="0.01"/>
        </div>
        <div class="field">
          <label for="kTestInput" data-label-base="Тестирование" data-label-code="TEST">Тестирование (TEST)</label>
          <input id="kTestInput" type="number" step="0.01"/>
        </div>
        <div class="field">
          <label for="kDocInput" data-label-base="Документирование" data-label-code="DOC">Документирование (DOC)</label>
          <input id="kDocInput" type="number" step="0.01"/>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label>Флаги</label>
          <div>
            <label class="toggle-switch">
              <input type="checkbox" id="flagUniqueLogicInput"/>
              <span>Уникальная логика</span>
            </label>
          </div>
          <div>
            <label class="toggle-switch">
              <input type="checkbox" id="flagSystemCalcInput"/>
              <span>Системные расчёты</span>
            </label>
          </div>
        </div>
        <div class="field" style="flex:2 1 260px;">
          <label for="elementCommentInput">Комментарий</label>
          <textarea id="elementCommentInput" placeholder="Обязательно для индивидуальных элементов (cfg_type = individual)"></textarea>
        </div>
      </div>

      <div class="formula-block" id="formulaBlock">
CFG_base определяется по cfg_type:
  • fixed: CFG_base = cfg_fixed
  • range: CFG_min ≤ CFG_base ≤ CFG_max (ввод пользователя)
  • individual: CFG_base — произвольное значение пользователя (с ограничением cfg_custom_max, если задан)

Наращивание трудоёмкости (scaling_type):
  • additive:
      if value ≤ base_value:
          CFG_intermediate = CFG_base
      else:
          steps = ceil((value - base_value) / step)
          CFG_intermediate = CFG_base + steps * delta_cfg

  • multiplicative:
      if value ≤ base_value:
          CFG_intermediate = CFG_base
      else:
          steps = ceil((value - base_value) / step)
          CFG_intermediate = CFG_base * (multiplier ^ steps)

  • package:
      packs = ceil(value / pack_size)
      CFG_intermediate = CFG_base * packs

  • none:
      CFG_intermediate = CFG_base

Применение флагов:
  if has_unique_logic_flag:       CFG_intermediate *= 2
  if has_system_calculations_flag: CFG_intermediate *= 2

Итоговые значения:
  Eff_CFG  = CFG_intermediate * Qty
  Eff_ANDS = Eff_CFG * k_ANDS
  Eff_TEST = Eff_CFG * k_TEST
  Eff_DOC  = Eff_CFG * k_DOC
  Eff_TOTAL_element = Eff_CFG + Eff_ANDS + Eff_TEST + Eff_DOC
      </div>

      <div class="warning-block" id="validationHintBlock">
Для элементов с cfg_type = range требуйте, чтобы CFG базовое находилось в диапазоне [cfg_min; cfg_max].<br/>
Для элементов с cfg_type = individual обязательно указывайте комментарий и, при наличии cfg_custom_max, не превышайте его.
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="button-secondary" id="elementCancelBtn">Отмена</button>
      <button type="button" class="button-primary" id="elementSaveBtn">Сохранить</button>
    </div>
  </div>
</div>

<!-- Модальное окно: методика -->
<div class="modal-backdrop" id="methodologyModalBackdrop">
  <div class="modal" style="max-width:1100px;">
    <div class="modal-header">
      <h3>Исходные данные методики (каталог из Excel)</h3>
      <button type="button" class="button-ghost button-sm" id="closeMethodologyModalBtn">Закрыть</button>
    </div>
    <div class="modal-body">
      <div class="upload-hint" style="margin-bottom:4px;">
        Одна строка Excel = один элемент методики. Отображаются все обязательные поля.
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <label class="toggle-switch">
          <input type="checkbox" id="collapseMethodologyTable" checked>
          <span>Сжать таблицу по ширине</span>
        </label>
        <div style="margin-left:auto;display:flex;gap:6px;">
          <button type="button" class="button-secondary" id="exportMethodologyExcelBtn">Выгрузить Excel</button>
          <button type="button" class="button-secondary" id="exportMethodologyJsonBtn">Выгрузить JSON</button>
          <button type="button" class="button-secondary" id="importMethodologyJsonBtn">Загрузить JSON</button>
          <input type="file" id="methodologyJsonInput" accept=".json" style="display:none;" />
        </div>
      </div>
      <div class="table-wrapper" id="methodologyTableWrapper" style="max-height:400px;">
        <table id="methodologyTable">
          <thead>
          <tr>
            <th>group_code</th>
            <th>group_name</th>
            <th>element_code</th>
            <th>element_name</th>
            <th>cfg_type</th>
            <th>cfg_min</th>
            <th>cfg_max</th>
            <th>cfg_fixed</th>
            <th>ands_coeff</th>
            <th>test_coeff</th>
            <th>doc_coeff</th>
            <th>scaling_type</th>
            <th>base_value</th>
            <th>step</th>
            <th>delta_cfg</th>
            <th>multiplier</th>
            <th>pack_size</th>
            <th>has_unique_logic_flag</th>
            <th>has_system_calculations_flag</th>
            <th>is_individual</th>
            <th>cfg_custom_max</th>
          </tr>
          </thead>
          <tbody id="methodologyTableBody">
          <!-- строки методики -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="button-secondary" id="methodologyOkBtn">Закрыть</button>
    </div>
  </div>
</div>

<!-- Подключение библиотеки xlsx (локальный файл в той же папке) -->
<script src="xlsx.full.min.js"></script>

<script>
  // === Глобальное состояние ===
  let methodologyRows = [];          // строки методики из Excel
  let groupsMap = new Map();         // group_code -> { code, name, color, stats }
  let calcItems = [];                // элементы в таблице расчётов
  let hasMethodology = false;
  let showCodes = false;
  let editingItemId = null;
  let methodFileName = '';
  let activeOnlyGroup = null;

  let nextItemId = 1;

  const REQUIRED_COLUMNS = [
    'group_code',
    'group_name',
    'element_code',
    'element_name',
    'complexity_score_min',
    'complexity_score_max',
    'area',
    'category_label',
    'cfg_type',
    'cfg_min',
    'cfg_max',
    'cfg_fixed',
    'ands_coeff',
    'test_coeff',
    'doc_coeff',
    'scaling_type',
    'base_value',
    'base_unit',
    'step',
    'delta_cfg',
    'multiplier',
    'pack_size',
    'has_unique_logic_flag',
    'has_system_calculations_flag',
    'is_individual',
    'cfg_custom_max',
    'short_description'
  ];

  const METHODOLOGY_COLUMNS = [
    'group_code', 'group_name', 'element_code', 'element_name', 'cfg_type', 'cfg_min', 'cfg_max', 'cfg_fixed',
    'ands_coeff', 'test_coeff', 'doc_coeff', 'scaling_type', 'base_value', 'step', 'delta_cfg', 'multiplier',
    'pack_size', 'has_unique_logic_flag', 'has_system_calculations_flag', 'is_individual', 'cfg_custom_max'
  ];

  const METHODOLOGY_NUMBER_FIELDS = new Set([
    'cfg_min', 'cfg_max', 'cfg_fixed', 'ands_coeff', 'test_coeff', 'doc_coeff', 'base_value', 'step', 'delta_cfg',
    'multiplier', 'pack_size', 'cfg_custom_max'
  ]);

  const METHODOLOGY_BOOL_FIELDS = new Set([
    'has_unique_logic_flag', 'has_system_calculations_flag', 'is_individual'
  ]);

  // === Утилиты ===

  function fmtNumber(value, digits = 2) {
    if (!isFinite(value)) return '0';
    return Number(value).toFixed(digits);
  }

  function colorPaletteFromCode(code) {
    let hash = 0;
    for (let i = 0; i < code.length; i++) {
      hash = ((hash << 5) - hash) + code.charCodeAt(i);
      hash |= 0;
    }
    const h = (hash % 360 + 360) % 360;
    return {
      header: `hsl(${h},70%,90%)`,
      soft: `hsl(${h},70%,96%)`,
      border: `hsl(${h},65%,76%)`,
      accent: `linear-gradient(135deg, hsl(${h},70%,90%), #ffffff)`
    };
  }

  function downloadFile(filename, content, mime = 'text/plain;charset=utf-8') {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function parseBoolFlag(v) {
    if (typeof v === 'boolean') return v;
    if (v == null) return false;
    const s = String(v).trim().toLowerCase();
    return s === '1' || s === 'true' || s === 'да' || s === 'yes' || s === 'y';
  }

  function safeNumber(v, def = 0) {
    if (v === '' || v == null) return def;
    const n = Number(v);
    return isFinite(n) ? n : def;
  }

  function labelWithCode(base, code) {
    if (!code) return base;
    return showCodes ? `${base} — ${code}` : base;
  }

  // === Инициализация ===

  document.addEventListener('DOMContentLoaded', () => {
    bindGeneralControls();
    resetState();
    applyLabels();
  });

  function applyLabels() {
    document.querySelectorAll('[data-label-base]').forEach(el => {
      const base = el.getAttribute('data-label-base') || '';
      const code = el.getAttribute('data-label-code') || '';
      const label = labelWithCode(base, code);
      const target = el.querySelector('.label-text');
      if (target) {
        target.textContent = label;
      } else {
        el.textContent = label;
      }
    });
  }

  function toggleCalcTableWidth() {
    const wrapper = document.getElementById('calcTableWrapper');
    const checked = document.getElementById('collapseCalcTable').checked;
    if (wrapper) wrapper.classList.toggle('compressed-table', checked);
  }

  function toggleMethodologyTableWidth() {
    const wrapper = document.getElementById('methodologyTableWrapper');
    const checkbox = document.getElementById('collapseMethodologyTable');
    if (wrapper && checkbox) {
      wrapper.classList.toggle('compressed-table', checkbox.checked);
    }
  }

  function bindGeneralControls() {
    document.getElementById('toggleProjectMetaBtn').addEventListener('click', () => {
      const body = document.getElementById('projectMetaBody');
      const btn = document.getElementById('toggleProjectMetaBtn');
      const hidden = body.classList.toggle('hidden');
      btn.textContent = hidden ? 'Развернуть' : 'Свернуть';
      updateProjectTitle();
    });

    document.getElementById('projectName').addEventListener('input', updateProjectTitle);

    document.getElementById('toggleMethodSectionBtn').addEventListener('click', () => {
      const body = document.getElementById('methodSectionBody');
      const hidden = body.classList.toggle('hidden');
      document.getElementById('toggleMethodSectionBtn').textContent = hidden ? 'Развернуть' : 'Свернуть';
      updateMethodTitle();
    });

    document.getElementById('toggleExtrasBtn').addEventListener('click', () => {
      const body = document.getElementById('extrasBody');
      const btn = document.getElementById('toggleExtrasBtn');
      const hidden = body.classList.toggle('hidden');
      btn.textContent = hidden ? 'Развернуть' : 'Свернуть';
    });

    document.getElementById('excelInput').addEventListener('change', handleExcelUpload);

    document.getElementById('toggleShowCodes').addEventListener('change', (e) => {
      showCodes = e.target.checked;
      applyLabels();
      renderSectionsCards();
      renderCalcTable();
      updateTotalsLabels();
    });

    document.getElementById('exportDetailCsvBtn').addEventListener('click', exportDetailCsv);

    document.getElementById('addRowFromHeaderBtn').addEventListener('click', () => {
      const firstGroup = Array.from(groupsMap.values())[0];
      if (firstGroup) {
        openElementModalForGroup(firstGroup.code);
      } else {
        openElementModalForGroup(null);
      }
    });

    document.getElementById('saveSnapshotBtn').addEventListener('click', saveSnapshot);
    document.getElementById('loadSnapshotBtn').addEventListener('click', () => {
      document.getElementById('snapshotFileInput').click();
    });
    document.getElementById('snapshotFileInput').addEventListener('change', handleSnapshotUpload);

    document.getElementById('openMethodologyBtn').addEventListener('click', () => {
      openMethodologyModal();
    });
    document.getElementById('closeMethodologyModalBtn').addEventListener('click', () => {
      closeMethodologyModal();
    });
    document.getElementById('methodologyOkBtn').addEventListener('click', () => {
      closeMethodologyModal();
    });

    document.getElementById('exportMethodologyExcelBtn').addEventListener('click', exportMethodologyExcel);
    document.getElementById('exportMethodologyJsonBtn').addEventListener('click', exportMethodologyJson);
    document.getElementById('importMethodologyJsonBtn').addEventListener('click', () => {
      document.getElementById('methodologyJsonInput').click();
    });
    document.getElementById('methodologyJsonInput').addEventListener('change', handleMethodologyJsonUpload);

    document.getElementById('collapseCalcTable').addEventListener('change', toggleCalcTableWidth);
    document.getElementById('collapseMethodologyTable').addEventListener('change', toggleMethodologyTableWidth);

    document.getElementById('kPlatformInput').addEventListener('input', () => {
      recalcTotals();
    });

    document.getElementById('closeElementModalBtn').addEventListener('click', () => {
      closeElementModal();
    });
    document.getElementById('elementCancelBtn').addEventListener('click', () => {
      closeElementModal();
    });
    document.getElementById('elementSaveBtn').addEventListener('click', handleElementSave);

    document.getElementById('elementSectionSelect').addEventListener('change', handleElementSectionChange);
    document.getElementById('elementTypeSelect').addEventListener('change', handleElementTypeChange);
  }

  function updateProjectTitle() {
    const name = (document.getElementById('projectName').value || '').trim();
    const bodyHidden = document.getElementById('projectMetaBody').classList.contains('hidden');
    const title = document.getElementById('projectTitle');
    if (bodyHidden && name) {
      title.textContent = `Реквизиты проекта — ${name}`;
    } else {
      title.textContent = 'Реквизиты проекта';
    }
  }

  function updateMethodTitle() {
    const bodyHidden = document.getElementById('methodSectionBody').classList.contains('hidden');
    const title = document.getElementById('methodTitle');
    if (bodyHidden && methodFileName) {
      title.textContent = `Загрузка методики (Excel) — ${methodFileName}`;
    } else {
      title.textContent = 'Загрузка методики (Excel)';
    }
  }

  function setDefaultProjectMeta() {
    const today = new Date();
    const iso = today.toISOString().slice(0, 10);
    document.getElementById('calcDate').value = iso;
    document.getElementById('calcVersion').value = '1';
    document.getElementById('executor').value = 'ООО «Сибирские интеграционные системы»';
    document.getElementById('projectName').value = '';
    document.getElementById('customer').value = '';
  }

  function updateTotalsLabels() {
    document.getElementById('totalCfgLabel').textContent = labelWithCode('Трудоёмкость конфигурирования', 'CFG');
    document.getElementById('totalAndsLabel').textContent = labelWithCode('Анализ и проектирование', 'ANDS');
    document.getElementById('totalTestLabel').textContent = labelWithCode('Тестирование', 'TEST');
    document.getElementById('totalDocLabel').textContent = labelWithCode('Документирование', 'DOC');
    document.getElementById('totalOverallLabel').textContent = labelWithCode('Итоговая трудоёмкость', 'TOTAL') + ' (с учётом ' + labelWithCode('Коэффициента платформы', 'K_platform') + ')';
  }

  function resetState() {
    methodologyRows = [];
    groupsMap.clear();
    calcItems = [];
    hasMethodology = false;
    showCodes = false;
    editingItemId = null;
    methodFileName = '';
    activeOnlyGroup = null;
    nextItemId = 1;

    document.getElementById('methodStatusBadge').textContent = 'Методика не загружена';
    document.getElementById('sectionsSummaryBadge').textContent = 'Разделы: 0';
    document.getElementById('rowsSummaryBadge').textContent = 'Строк: 0';

    document.getElementById('sectionsContainer').innerHTML = '';
    document.getElementById('noSectionsHint').classList.remove('hidden');
    document.getElementById('calcTableBody').innerHTML = '';

    document.getElementById('kPlatformInput').disabled = true;
    document.getElementById('openMethodologyBtn').disabled = true;
    document.getElementById('toggleShowCodes').disabled = true;
    document.getElementById('exportDetailCsvBtn').disabled = true;
    document.getElementById('saveSnapshotBtn').disabled = true;
    document.getElementById('loadSnapshotBtn').disabled = true;

    document.getElementById('methodSectionBody').classList.remove('hidden');
    document.getElementById('toggleMethodSectionBtn').textContent = 'Свернуть';
    document.getElementById('methodSuccessHint').style.display = 'none';

    setDefaultProjectMeta();
    updateProjectTitle();
    updateMethodTitle();
    updateTotalsLabels();
    applyLabels();
    toggleCalcTableWidth();
    toggleMethodologyTableWidth();

    setTotals(0, 0, 0, 0, 0);
  }

  // === Загрузка Excel ===

  function handleExcelUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    methodFileName = file.name;
    updateMethodTitle();

    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[firstSheetName];
        if (!sheet) {
          alert('Ошибка: в файле нет листов.');
          return;
        }
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });
        if (!rows || rows.length === 0) {
          alert('Ошибка: лист пустой или не содержит данных.');
          return;
        }

        const headerRow = rows[0];
        const missing = REQUIRED_COLUMNS.filter(col => !(col in headerRow));
        if (missing.length > 0) {
          alert('Ошибка: в методике отсутствуют обязательные столбцы:\n' + missing.join(', '));
          return;
        }

        methodologyRows = rows.map((r, idx) => ({
          _index: idx,
          group_code: String(r.group_code ?? '').trim(),
          group_name: String(r.group_name ?? '').trim(),
          element_code: String(r.element_code ?? '').trim(),
          element_name: String(r.element_name ?? '').trim(),
          complexity_score_min: safeNumber(r.complexity_score_min),
          complexity_score_max: safeNumber(r.complexity_score_max),
          area: r.area,
          category_label: r.category_label,
          cfg_type: String(r.cfg_type ?? '').trim().toLowerCase(),
          cfg_min: safeNumber(r.cfg_min),
          cfg_max: safeNumber(r.cfg_max),
          cfg_fixed: safeNumber(r.cfg_fixed),
          ands_coeff: safeNumber(r.ands_coeff),
          test_coeff: safeNumber(r.test_coeff),
          doc_coeff: safeNumber(r.doc_coeff),
          scaling_type: String(r.scaling_type ?? '').trim().toLowerCase(),
          base_value: safeNumber(r.base_value),
          base_unit: r.base_unit,
          step: safeNumber(r.step),
          delta_cfg: safeNumber(r.delta_cfg),
          multiplier: safeNumber(r.multiplier || 1),
          pack_size: safeNumber(r.pack_size || 1),
          has_unique_logic_flag: parseBoolFlag(r.has_unique_logic_flag),
          has_system_calculations_flag: parseBoolFlag(r.has_system_calculations_flag),
          is_individual: parseBoolFlag(r.is_individual),
          cfg_custom_max: safeNumber(r.cfg_custom_max || 0),
          short_description: String(r.short_description ?? '').trim()
        }));

        buildGroupsFromMethodology();
        hasMethodology = true;
        onMethodologyLoaded();
        document.getElementById('methodSuccessHint').style.display = 'block';
        updateMethodTitle();
      } catch (err) {
        console.error(err);
        alert('Ошибка при чтении файла Excel: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function buildGroupsFromMethodology() {
    groupsMap.clear();
    methodologyRows.forEach(row => {
      const code = row.group_code || 'NO_CODE';
      const name = row.group_name || 'Без названия';
      let group = groupsMap.get(code);
      if (!group) {
        group = {
          code,
          name,
          color: colorPaletteFromCode(code),
          rows: [],
          state: { hidden: false },
          stats: {
            itemsCount: 0,
            cfgBaseSum: 0,
            totalWithoutK: 0
          }
        };
        groupsMap.set(code, group);
      }
      group.rows.push(row);
    });
  }

  function onMethodologyLoaded() {
    document.getElementById('methodStatusBadge').textContent = 'Методика загружена';
    document.getElementById('kPlatformInput').disabled = false;
    document.getElementById('openMethodologyBtn').disabled = false;
    document.getElementById('toggleShowCodes').disabled = false;
    document.getElementById('exportDetailCsvBtn').disabled = false;
    document.getElementById('saveSnapshotBtn').disabled = false;
    document.getElementById('loadSnapshotBtn').disabled = false;

    renderSectionsCards();
    renderMethodologyTable();
    updateTotalsLabels();
    applyLabels();
  }

  // === Карточки разделов ===

  function renderSectionsCards() {
    const container = document.getElementById('sectionsContainer');
    container.innerHTML = '';

    const groups = Array.from(groupsMap.values());
    if (groups.length === 0) {
      document.getElementById('noSectionsHint').classList.remove('hidden');
      document.getElementById('sectionsSummaryBadge').textContent = 'Разделы: 0';
      return;
    }
    document.getElementById('noSectionsHint').classList.add('hidden');
    document.getElementById('sectionsSummaryBadge').textContent = 'Разделы: ' + groups.length;

    groups.forEach(group => {
      const card = document.createElement('div');
      card.className = 'section-card';
      card.dataset.groupCode = group.code;
      card.style.backgroundImage = group.color.accent;
      card.style.borderColor = group.color.border;

      const header = document.createElement('div');
      header.className = 'section-card-header';

      const title = document.createElement('div');
      title.className = 'section-card-title';
      title.textContent = group.name || group.code;
      header.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'section-card-meta';
      meta.innerHTML = `
        <div class="stat-line"><span>Строк методики:</span><span>${group.rows.length}</span></div>
        <div class="stat-line"><span>${labelWithCode('Трудоёмкость конфигурирования — CFG базовое', 'CFG')}:</span><span data-role="cfg-base">0</span></div>
        <div class="stat-line"><span>Σ (без ${labelWithCode('K_platform', 'K_platform')}):</span><span data-role="sum-no-k">0</span></div>
      `;
      header.appendChild(meta);

      const body = document.createElement('div');
      body.className = 'section-card-body';

      const flags = document.createElement('div');
      flags.className = 'section-card-flags';
      const hideId = `hide_${group.code}`;
      const onlyId = `only_${group.code}`;
      flags.innerHTML = `
        <div style=\"display:flex;gap:12px;align-items:center;flex-wrap:wrap;\">\
          <label style=\"display:flex;align-items:center;gap:6px;\">\
            <input type=\"checkbox\" id=\"${hideId}\"/>\
            <span>Скрыть этот раздел</span>\
          </label>\
          <label style=\"display:flex;align-items:center;gap:6px;\">\
            <input type=\"checkbox\" id=\"${onlyId}\"/>\
            <span>Показать только этот раздел</span>\
          </label>\
        </div>
      `;
      
      body.appendChild(flags);

      const footer = document.createElement('div');
      footer.className = 'section-card-footer';

      const indicator = document.createElement('div');
      indicator.className = 'empty-badge';
      indicator.textContent = 'Пустой раздел';
      indicator.dataset.role = 'empty-badge';
      footer.appendChild(indicator);

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'button-primary button-sm';
      btn.textContent = 'Добавить элемент';
      btn.disabled = !hasMethodology;
      btn.addEventListener('click', () => {
        openElementModalForGroup(group.code);
      });
      footer.appendChild(btn);

      body.appendChild(footer);

      card.appendChild(header);
      card.appendChild(body);

      container.appendChild(card);

      const hideCheckbox = document.getElementById(hideId);
      const onlyCheckbox = document.getElementById(onlyId);
      hideCheckbox.checked = group.state.hidden;
      onlyCheckbox.checked = activeOnlyGroup === group.code;
      card.classList.toggle('inactive', group.state.hidden || (activeOnlyGroup && activeOnlyGroup !== group.code));

      hideCheckbox.addEventListener('change', () => {
        const hidden = hideCheckbox.checked;
        group.state.hidden = hidden;
        card.classList.toggle('inactive', hidden || (activeOnlyGroup && activeOnlyGroup !== group.code));
        if (hidden) {
          onlyCheckbox.checked = false;
          if (activeOnlyGroup === group.code) activeOnlyGroup = null;
        }
        renderCalcTable();
      });

      onlyCheckbox.addEventListener('change', () => {
        const onlyChecked = onlyCheckbox.checked;
        activeOnlyGroup = onlyChecked ? group.code : null;
        if (onlyChecked) {
          container.querySelectorAll('input[id^="only_"]').forEach(inp => {
            if (inp.id !== onlyId) inp.checked = false;
          });
        }
        updateCardsState();
        renderCalcTable();
      });
    });

    updateCardsState();
    recalcGroupStats();
  }

  function updateCardsState() {
    const container = document.getElementById('sectionsContainer');
    container.querySelectorAll('.section-card').forEach(card => {
      const code = card.dataset.groupCode;
      const group = groupsMap.get(code);
      const hidden = group?.state.hidden;
      const onlyFiltered = activeOnlyGroup && activeOnlyGroup !== code;
      card.classList.toggle('inactive', hidden || onlyFiltered);
    });
  }

  function recalcGroupStats() {
    // обнулить
    groupsMap.forEach(group => {
      group.stats.itemsCount = 0;
      group.stats.cfgBaseSum = 0;
      group.stats.totalWithoutK = 0;
    });

    calcItems.forEach(item => {
      const group = groupsMap.get(item.group_code);
      if (!group || group.state.hidden) return;
      if (activeOnlyGroup && activeOnlyGroup !== item.group_code) return;
      group.stats.itemsCount++;
      group.stats.cfgBaseSum += item.cfg_base || 0;
      group.stats.totalWithoutK += item.eff_total || 0;
    });

    const cards = document.querySelectorAll('.section-card');
    cards.forEach(card => {
      const code = card.dataset.groupCode;
      const group = groupsMap.get(code);
      if (!group) return;
      const cfgSpan = card.querySelector('[data-role="cfg-base"]');
      const sumSpan = card.querySelector('[data-role="sum-no-k"]');
      const rowsSpan = card.querySelector('[data-role="row-count"]');
      const emptyBadge = card.querySelector('[data-role="empty-badge"]');
      if (cfgSpan) cfgSpan.textContent = fmtNumber(group.stats.cfgBaseSum, 2);
      if (sumSpan) sumSpan.textContent = fmtNumber(group.stats.totalWithoutK, 2);
      if (rowsSpan) rowsSpan.textContent = group.stats.itemsCount;
      if (emptyBadge) {
        if (group.stats.itemsCount === 0) {
          emptyBadge.textContent = 'Пустой раздел';
        } else {
          emptyBadge.textContent = `Строк в таблице: ${group.stats.itemsCount}`;
        }
        emptyBadge.style.display = 'inline-block';
      }
    });
  }

  // === Модальное окно элемента ===

  function openElementModalForGroup(groupCode) {
    if (!hasMethodology) {
      alert('Сначала загрузите Excel-методику.');
      return;
    }
    const firstGroup = Array.from(groupsMap.values())[0];
    const targetGroupCode = groupCode || firstGroup?.code;
    if (!targetGroupCode) {
      alert('Нет доступных разделов для добавления элементов.');
      return;
    }
    editingItemId = null;
    const group = groupsMap.get(targetGroupCode);
    const sectionSelect = document.getElementById('elementSectionSelect');
    const typeSelect = document.getElementById('elementTypeSelect');
    const nameInput = document.getElementById('elementNameInput');
    const qtyInput = document.getElementById('elementQtyInput');
    const cfgBaseInput = document.getElementById('cfgBaseInput');
    const valueInput = document.getElementById('valueInput');
    const kAndsInput = document.getElementById('kAndsInput');
    const kTestInput = document.getElementById('kTestInput');
    const kDocInput = document.getElementById('kDocInput');
    const flagUnique = document.getElementById('flagUniqueLogicInput');
    const flagSystem = document.getElementById('flagSystemCalcInput');
    const commentInput = document.getElementById('elementCommentInput');

    // заполнить список разделов
    sectionSelect.innerHTML = '';
    Array.from(groupsMap.values()).forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.code;
      opt.textContent = g.name || g.code;
      if (g.code === targetGroupCode) opt.selected = true;
      sectionSelect.appendChild(opt);
    });

    // заполнить список типов элементов для выбранного раздела
    fillElementTypesForGroup(targetGroupCode);

    qtyInput.value = '1';
    cfgBaseInput.value = '';
    valueInput.value = '0';
    kAndsInput.value = '';
    kTestInput.value = '';
    kDocInput.value = '';
    flagUnique.checked = false;
    flagSystem.checked = false;
    commentInput.value = '';
    nameInput.value = '';

    document.getElementById('elementModalBackdrop').style.display = 'flex';
  }

  function handleElementSectionChange() {
    const sectionSelect = document.getElementById('elementSectionSelect');
    const groupCode = sectionSelect.value;
    fillElementTypesForGroup(groupCode);
  }

  function fillElementTypesForGroup(groupCode) {
    const typeSelect = document.getElementById('elementTypeSelect');
    const nameInput = document.getElementById('elementNameInput');
    const cfgBaseInput = document.getElementById('cfgBaseInput');
    const valueInput = document.getElementById('valueInput');
    const kAndsInput = document.getElementById('kAndsInput');
    const kTestInput = document.getElementById('kTestInput');
    const kDocInput = document.getElementById('kDocInput');
    const flagUnique = document.getElementById('flagUniqueLogicInput');
    const flagSystem = document.getElementById('flagSystemCalcInput');

    typeSelect.innerHTML = '';
    const rows = methodologyRows.filter(r => (r.group_code || 'NO_CODE') === groupCode);
    rows.forEach(row => {
      const opt = document.createElement('option');
      opt.value = String(row._index);
      opt.textContent = `${row.element_code || ''} — ${row.element_name || ''}`.trim();
      typeSelect.appendChild(opt);
    });

    if (rows.length > 0) {
      const row = rows[0];
      nameInput.value = row.element_name || '';
      const cfgType = row.cfg_type;
      if (cfgType === 'fixed') {
        cfgBaseInput.value = row.cfg_fixed || 0;
        cfgBaseInput.disabled = true;
      } else {
        cfgBaseInput.disabled = false;
        cfgBaseInput.value = cfgType === 'range' ? row.cfg_min || 0 : '';
      }
      valueInput.value = row.base_value || 0;
      kAndsInput.value = row.ands_coeff || 0;
      kTestInput.value = row.test_coeff || 0;
      kDocInput.value = row.doc_coeff || 0;
      flagUnique.checked = row.has_unique_logic_flag;
      flagSystem.checked = row.has_system_calculations_flag;
    } else {
      nameInput.value = '';
      cfgBaseInput.value = '';
      valueInput.value = '0';
      kAndsInput.value = '';
      kTestInput.value = '';
      kDocInput.value = '';
      flagUnique.checked = false;
      flagSystem.checked = false;
    }
  }

  function handleElementTypeChange() {
    const typeSelect = document.getElementById('elementTypeSelect');
    const idx = Number(typeSelect.value);
    const row = methodologyRows.find(r => r._index === idx);
    if (!row) return;

    const nameInput = document.getElementById('elementNameInput');
    const cfgBaseInput = document.getElementById('cfgBaseInput');
    const valueInput = document.getElementById('valueInput');
    const kAndsInput = document.getElementById('kAndsInput');
    const kTestInput = document.getElementById('kTestInput');
    const kDocInput = document.getElementById('kDocInput');
    const flagUnique = document.getElementById('flagUniqueLogicInput');
    const flagSystem = document.getElementById('flagSystemCalcInput');

    nameInput.value = row.element_name || '';
    const cfgType = row.cfg_type;
    if (cfgType === 'fixed') {
      cfgBaseInput.value = row.cfg_fixed || 0;
      cfgBaseInput.disabled = true;
    } else {
      cfgBaseInput.disabled = false;
      cfgBaseInput.value = cfgType === 'range' ? row.cfg_min || 0 : '';
    }
    valueInput.value = row.base_value || 0;
    kAndsInput.value = row.ands_coeff || 0;
    kTestInput.value = row.test_coeff || 0;
    kDocInput.value = row.doc_coeff || 0;
    flagUnique.checked = row.has_unique_logic_flag;
    flagSystem.checked = row.has_system_calculations_flag;
  }

  function closeElementModal() {
    document.getElementById('elementModalBackdrop').style.display = 'none';
    editingItemId = null;
  }

  function handleElementSave() {
    const sectionSelect = document.getElementById('elementSectionSelect');
    const typeSelect = document.getElementById('elementTypeSelect');
    const nameInput = document.getElementById('elementNameInput');
    const qtyInput = document.getElementById('elementQtyInput');
    const cfgBaseInput = document.getElementById('cfgBaseInput');
    const valueInput = document.getElementById('valueInput');
    const kAndsInput = document.getElementById('kAndsInput');
    const kTestInput = document.getElementById('kTestInput');
    const kDocInput = document.getElementById('kDocInput');
    const flagUnique = document.getElementById('flagUniqueLogicInput');
    const flagSystem = document.getElementById('flagSystemCalcInput');
    const commentInput = document.getElementById('elementCommentInput');

    const groupCode = sectionSelect.value;
    const group = groupsMap.get(groupCode);
    if (!group) {
      alert('Ошибка: не выбран раздел.');
      return;
    }

    const rowIndex = Number(typeSelect.value);
    const methodRow = methodologyRows.find(r => r._index === rowIndex);
    if (!methodRow) {
      alert('Ошибка: не выбран тип элемента.');
      return;
    }

    const qty = safeNumber(qtyInput.value, 0);
    if (qty <= 0) {
      alert('Ошибка: количество должно быть положительным.');
      return;
    }

    const cfgType = methodRow.cfg_type;
    let cfgBase = safeNumber(cfgBaseInput.value, NaN);
    if (cfgType === 'fixed') {
      cfgBase = methodRow.cfg_fixed || 0;
    } else if (cfgType === 'range') {
      if (!isFinite(cfgBase)) {
        alert('Ошибка: CFG базовое должно быть числом.');
        return;
      }
      const min = methodRow.cfg_min;
      const max = methodRow.cfg_max;
      if (cfgBase < min || cfgBase > max) {
        alert('CFG базовое для типа range должно быть в диапазоне [' + min + '; ' + max + '].');
        return;
      }
    } else if (cfgType === 'individual') {
      if (!isFinite(cfgBase)) {
        alert('Ошибка: CFG базовое (individual) должно быть числом.');
        return;
      }
      const customMax = methodRow.cfg_custom_max || 0;
      if (customMax > 0 && cfgBase > customMax) {
        alert('CFG базовое (individual) не должно превышать cfg_custom_max = ' + customMax);
        return;
      }
      const comment = (commentInput.value || '').trim();
      if (!comment) {
        alert('Для элементов с cfg_type = individual комментарий обязателен.');
        return;
      }
    }

    let value = safeNumber(valueInput.value, 0);
    const scalingType = methodRow.scaling_type || 'none';
    if ((scalingType === 'additive' || scalingType === 'multiplicative' || scalingType === 'package') && value <= 0) {
      if (!confirm('Параметр value ≤ 0 при типе scaling = ' + scalingType + '. Продолжить?')) {
        return;
      }
    }

    let cfgIntermediate = cfgBase;
    if (scalingType === 'additive') {
      if (value <= methodRow.base_value) {
        cfgIntermediate = cfgBase;
      } else {
        const steps = Math.ceil((value - methodRow.base_value) / (methodRow.step || 1));
        cfgIntermediate = cfgBase + steps * (methodRow.delta_cfg || 0);
      }
    } else if (scalingType === 'multiplicative') {
      if (value <= methodRow.base_value) {
        cfgIntermediate = cfgBase;
      } else {
        const steps = Math.ceil((value - methodRow.base_value) / (methodRow.step || 1));
        cfgIntermediate = cfgBase * Math.pow(methodRow.multiplier || 1, steps);
      }
    } else if (scalingType === 'package') {
      const packs = Math.ceil(value / (methodRow.pack_size || 1));
      cfgIntermediate = cfgBase * packs;
    } else {
      cfgIntermediate = cfgBase;
    }

    let uniqueFlag = flagUnique.checked || methodRow.has_unique_logic_flag;
    let systemFlag = flagSystem.checked || methodRow.has_system_calculations_flag;
    if (uniqueFlag) cfgIntermediate *= 2;
    if (systemFlag) cfgIntermediate *= 2;

    const effCfg = cfgIntermediate * qty;
    const kAnds = safeNumber(kAndsInput.value, methodRow.ands_coeff || 0);
    const kTest = safeNumber(kTestInput.value, methodRow.test_coeff || 0);
    const kDoc = safeNumber(kDocInput.value, methodRow.doc_coeff || 0);

    const effAnds = effCfg * kAnds;
    const effTest = effCfg * kTest;
    const effDoc = effCfg * kDoc;
    const effTotal = effCfg + effAnds + effTest + effDoc;

    const item = {
      id: editingItemId != null ? editingItemId : nextItemId++,
      group_code: group.code,
      group_name: group.name,
      element_code: methodRow.element_code,
      element_name: nameInput.value || methodRow.element_name,
      cfg_type: cfgType,
      scaling_type: scalingType,
      qty,
      cfg_base: cfgBase,
      value,
      k_ands: kAnds,
      k_test: kTest,
      k_doc: kDoc,
      cfg_intermediate: cfgIntermediate,
      eff_cfg: effCfg,
      eff_ands: effAnds,
      eff_test: effTest,
      eff_doc: effDoc,
      eff_total: effTotal,
      has_unique_logic_flag: uniqueFlag,
      has_system_calculations_flag: systemFlag,
      is_individual: methodRow.is_individual,
      comment: commentInput.value || ''
    };

    if (editingItemId != null) {
      const idx = calcItems.findIndex(x => x.id === editingItemId);
      if (idx >= 0) calcItems[idx] = item;
    } else {
      calcItems.push(item);
    }

    editingItemId = null;
    closeElementModal();
    renderCalcTable();
    recalcGroupStats();
    document.getElementById('rowsSummaryBadge').textContent = 'Строк: ' + calcItems.length;
  }

  function openElementModalForEdit(itemId) {
    const item = calcItems.find(x => x.id === itemId);
    if (!item) return;
    editingItemId = item.id;

    const sectionSelect = document.getElementById('elementSectionSelect');
    const typeSelect = document.getElementById('elementTypeSelect');
    const nameInput = document.getElementById('elementNameInput');
    const qtyInput = document.getElementById('elementQtyInput');
    const cfgBaseInput = document.getElementById('cfgBaseInput');
    const valueInput = document.getElementById('valueInput');
    const kAndsInput = document.getElementById('kAndsInput');
    const kTestInput = document.getElementById('kTestInput');
    const kDocInput = document.getElementById('kDocInput');
    const flagUnique = document.getElementById('flagUniqueLogicInput');
    const flagSystem = document.getElementById('flagSystemCalcInput');
    const commentInput = document.getElementById('elementCommentInput');

    // разделы
    sectionSelect.innerHTML = '';
    Array.from(groupsMap.values()).forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.code;
      opt.textContent = g.name || g.code;
      if (g.code === item.group_code) opt.selected = true;
      sectionSelect.appendChild(opt);
    });

    // типы элементов
    fillElementTypesForGroup(item.group_code);

    // попытаться выбрать элемент по коду+имени
    const matchedRow = methodologyRows.find(r =>
      (r.group_code || '') === item.group_code &&
      (r.element_code || '') === item.element_code &&
      (r.element_name || '') === item.element_name
    );
    if (matchedRow) {
      typeSelect.value = String(matchedRow._index);
    }

    nameInput.value = item.element_name || '';
    qtyInput.value = item.qty;
    cfgBaseInput.disabled = (item.cfg_type === 'fixed');
    cfgBaseInput.value = item.cfg_base;
    valueInput.value = item.value;
    kAndsInput.value = item.k_ands;
    kTestInput.value = item.k_test;
    kDocInput.value = item.k_doc;
    flagUnique.checked = item.has_unique_logic_flag;
    flagSystem.checked = item.has_system_calculations_flag;
    commentInput.value = item.comment || '';

    document.getElementById('elementModalBackdrop').style.display = 'flex';
  }

  // === Таблица расчётов ===

  function renderCalcTable() {
    const tbody = document.getElementById('calcTableBody');
    tbody.innerHTML = '';

    let index = 1;
    Array.from(groupsMap.values()).forEach(group => {
      if (!group) return;
      if (group.state.hidden) return;
      if (activeOnlyGroup && activeOnlyGroup !== group.code) return;
      const items = calcItems.filter(it => it.group_code === group.code);
      if (items.length === 0) return;

      const groupRow = document.createElement('tr');
      groupRow.className = 'group-header-row';
      groupRow.style.background = group.color.header;
      const groupCell = document.createElement('td');
      groupCell.colSpan = 16;
      groupCell.textContent = labelWithCode(group.name || group.code, group.code);
      groupRow.appendChild(groupCell);
      tbody.appendChild(groupRow);

      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.style.background = group.color.soft;

        const tdIdx = document.createElement('td');
        tdIdx.className = 'cell-number';
        tdIdx.textContent = String(index++);
        tr.appendChild(tdIdx);

        const tdSection = document.createElement('td');
        tdSection.textContent = labelWithCode(item.group_name || item.group_code, item.group_code);
        tr.appendChild(tdSection);

        const tdElement = document.createElement('td');
        let text = '';
        if (showCodes && item.element_code) {
          text = `${item.element_name || ''} — ${item.element_code}`;
        } else {
          text = item.element_name || item.element_code || '';
        }
        tdElement.textContent = text;
        if (item.cfg_type === 'individual') {
          const tag = document.createElement('span');
          tag.className = 'tag-flag';
          tag.textContent = 'individual';
          tdElement.appendChild(tag);
        }
        if (item.scaling_type && item.scaling_type !== 'none') {
          const tag = document.createElement('span');
          tag.className = 'tag-flag';
          tag.textContent = item.scaling_type;
          tdElement.appendChild(tag);
        }
        tr.appendChild(tdElement);

        const tdCfgBase = document.createElement('td');
        tdCfgBase.className = 'cell-number';
        tdCfgBase.textContent = fmtNumber(item.cfg_base, 3);
        tr.appendChild(tdCfgBase);

        const tdKAnds = document.createElement('td');
        tdKAnds.className = 'cell-number';
        tdKAnds.textContent = fmtNumber(item.k_ands, 2);
        tr.appendChild(tdKAnds);

        const tdKTest = document.createElement('td');
        tdKTest.className = 'cell-number';
        tdKTest.textContent = fmtNumber(item.k_test, 2);
        tr.appendChild(tdKTest);

        const tdKDoc = document.createElement('td');
        tdKDoc.className = 'cell-number';
        tdKDoc.textContent = fmtNumber(item.k_doc, 2);
        tr.appendChild(tdKDoc);

        const tdKi = document.createElement('td');
        tdKi.className = 'cell-number';
        const ki = 1 + item.k_ands + item.k_test + item.k_doc;
        tdKi.textContent = fmtNumber(ki, 2);
        tr.appendChild(tdKi);

        const tdQty = document.createElement('td');
        tdQty.className = 'cell-number';
        tdQty.textContent = String(item.qty);
        tr.appendChild(tdQty);

        const tdTotalNoK = document.createElement('td');
        tdTotalNoK.className = 'cell-number';
        tdTotalNoK.textContent = fmtNumber(item.eff_total, 2);
        tr.appendChild(tdTotalNoK);

        const tdCfgPhase = document.createElement('td');
        tdCfgPhase.className = 'cell-number';
        tdCfgPhase.textContent = fmtNumber(item.eff_cfg, 2);
        tr.appendChild(tdCfgPhase);

        const tdAndsPhase = document.createElement('td');
        tdAndsPhase.className = 'cell-number';
        tdAndsPhase.textContent = fmtNumber(item.eff_ands, 2);
        tr.appendChild(tdAndsPhase);

        const tdTestPhase = document.createElement('td');
        tdTestPhase.className = 'cell-number';
        tdTestPhase.textContent = fmtNumber(item.eff_test, 2);
        tr.appendChild(tdTestPhase);

        const tdDocPhase = document.createElement('td');
        tdDocPhase.className = 'cell-number';
        tdDocPhase.textContent = fmtNumber(item.eff_doc, 2);
        tr.appendChild(tdDocPhase);

        const tdComment = document.createElement('td');
        tdComment.textContent = item.comment || '';
        tr.appendChild(tdComment);

        const tdActions = document.createElement('td');
        tdActions.className = 'cell-actions';
        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'action-icon';
        editBtn.textContent = '✏️';
        editBtn.title = 'Редактировать';
        editBtn.addEventListener('click', () => openElementModalForEdit(item.id));
        tdActions.appendChild(editBtn);

        const dupBtn = document.createElement('button');
        dupBtn.type = 'button';
        dupBtn.className = 'action-icon';
        dupBtn.textContent = '📑';
        dupBtn.title = 'Дублировать';
        dupBtn.addEventListener('click', () => duplicateItem(item.id));
        tdActions.appendChild(dupBtn);

        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'action-icon';
        delBtn.textContent = '❌';
        delBtn.title = 'Удалить';
        delBtn.addEventListener('click', () => {
          if (confirm('Удалить элемент из расчёта?')) {
            calcItems = calcItems.filter(x => x.id !== item.id);
            renderCalcTable();
            recalcGroupStats();
            document.getElementById('rowsSummaryBadge').textContent = 'Строк: ' + calcItems.length;
          }
        });
        tdActions.appendChild(delBtn);

        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    });

    recalcTotals();
    recalcGroupStats();
  }

  function duplicateItem(itemId) {
    const original = calcItems.find(x => x.id === itemId);
    if (!original) return;
    const copy = { ...original, id: nextItemId++ };
    calcItems.push(copy);
    renderCalcTable();
    recalcGroupStats();
    document.getElementById('rowsSummaryBadge').textContent = 'Строк: ' + calcItems.length;
  }

  function recalcTotals() {
    let sumCfg = 0;
    let sumAnds = 0;
    let sumTest = 0;
    let sumDoc = 0;
    let sumTotal = 0;

    calcItems.forEach(item => {
      const group = groupsMap.get(item.group_code);
      if (!group || group.state.hidden) return;
      if (activeOnlyGroup && activeOnlyGroup !== item.group_code) return;
      sumCfg += item.eff_cfg || 0;
      sumAnds += item.eff_ands || 0;
      sumTest += item.eff_test || 0;
      sumDoc += item.eff_doc || 0;
      sumTotal += item.eff_total || 0;
    });

    const kPlatform = safeNumber(document.getElementById('kPlatformInput').value || 1, 1);
    const totalWithK = sumTotal * kPlatform;

    setTotals(sumCfg, sumAnds, sumTest, sumDoc, totalWithK);
  }

  function setTotals(cfg, ands, test, doc, totalWithK) {
    document.getElementById('totalCfg').textContent = fmtNumber(cfg, 2);
    document.getElementById('totalAnds').textContent = fmtNumber(ands, 2);
    document.getElementById('totalTest').textContent = fmtNumber(test, 2);
    document.getElementById('totalDoc').textContent = fmtNumber(doc, 2);
    document.getElementById('totalOverall').textContent = fmtNumber(totalWithK, 2);
  }

  // === Методика: модальное окно ===

  function renderMethodologyTable() {
    const tbody = document.getElementById('methodologyTableBody');
    tbody.innerHTML = '';
    methodologyRows.forEach((row, rowIndex) => {
      const tr = document.createElement('tr');

      METHODOLOGY_COLUMNS.forEach(col => {
        const td = document.createElement('td');
        td.contentEditable = 'true';
        td.dataset.rowIndex = String(rowIndex);
        td.dataset.field = col;
        const value = row[col];
        if (METHODOLOGY_NUMBER_FIELDS.has(col)) {
          td.className = 'cell-number';
          td.textContent = value == null ? '' : fmtNumber(value, 3);
        } else if (METHODOLOGY_BOOL_FIELDS.has(col)) {
          td.className = 'cell-number';
          td.textContent = row[col] ? '1' : '0';
        } else {
          td.textContent = value == null ? '' : String(value);
        }
        td.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            td.blur();
          }
        });
        td.addEventListener('blur', handleMethodologyCellEdit);
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
  }

  function handleMethodologyCellEdit(event) {
    const td = event.target;
    const rowIndex = Number(td.dataset.rowIndex);
    const field = td.dataset.field;
    if (!Number.isInteger(rowIndex) || !field) return;

    const row = methodologyRows[rowIndex];
    if (!row) return;
    const text = td.textContent?.trim() ?? '';

    if (METHODOLOGY_NUMBER_FIELDS.has(field)) {
      row[field] = text === '' ? null : safeNumber(text, null);
      td.textContent = row[field] == null ? '' : fmtNumber(row[field], 3);
    } else if (METHODOLOGY_BOOL_FIELDS.has(field)) {
      row[field] = parseBoolFlag(text);
      td.textContent = row[field] ? '1' : '0';
    } else {
      row[field] = text;
    }

    buildGroupsFromMethodology();
    renderSectionsCards();
    renderCalcTable();
  }

  function openMethodologyModal() {
    if (!hasMethodology) {
      alert('Сначала загрузите Excel-методику.');
      return;
    }
    document.getElementById('methodologyModalBackdrop').style.display = 'flex';
  }

  function closeMethodologyModal() {
    document.getElementById('methodologyModalBackdrop').style.display = 'none';
  }

  function exportMethodologyExcel() {
    if (methodologyRows.length === 0) {
      alert('Нет данных методики для выгрузки.');
      return;
    }
    const rows = methodologyRows.map(({ _index, ...rest }) => rest);
    const sheet = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, sheet, 'methodology');
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'methodology.xlsx';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportMethodologyJson() {
    if (methodologyRows.length === 0) {
      alert('Нет данных методики для выгрузки.');
      return;
    }
    const rows = methodologyRows.map(({ _index, ...rest }) => rest);
    downloadFile('methodology.json', JSON.stringify(rows, null, 2), 'application/json');
  }

  function handleMethodologyJsonUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const data = JSON.parse(e.target.result);
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('JSON не содержит данных методики.');
        }
        methodologyRows = data.map((r, idx) => {
          const normalized = {};
          METHODOLOGY_COLUMNS.forEach(col => {
            if (METHODOLOGY_NUMBER_FIELDS.has(col)) {
              normalized[col] = safeNumber(r[col], null);
            } else if (METHODOLOGY_BOOL_FIELDS.has(col)) {
              normalized[col] = parseBoolFlag(r[col]);
            } else {
              normalized[col] = r[col];
            }
          });
          return { _index: idx, ...normalized };
        });
        buildGroupsFromMethodology();
        hasMethodology = true;
        onMethodologyLoaded();
        renderMethodologyTable();
        methodFileName = file.name || 'methodology.json';
        document.getElementById('methodSuccessHint').style.display = 'block';
        updateMethodTitle();
      } catch (err) {
        alert('Ошибка при загрузке JSON: ' + err.message);
      } finally {
        event.target.value = '';
      }
    };
    reader.readAsText(file, 'utf-8');
  }

  function exportDetailCsv() {
    if (calcItems.length === 0) {
      alert('Нет данных для экспорта.');
      return;
    }
    const rows = [];
    rows.push([
      '№',
      'group_code',
      'group_name',
      'element_code',
      'element_name',
      'cfg_type',
      'scaling_type',
      'qty',
      'cfg_base',
      'value',
      'k_ANDS',
      'k_TEST',
      'k_DOC',
      'cfg_intermediate',
      'Eff_CFG',
      'Eff_ANDS',
      'Eff_TEST',
      'Eff_DOC',
      'Eff_TOTAL_element',
      'has_unique_logic_flag',
      'has_system_calculations_flag',
      'is_individual',
      'comment'
    ]);

    calcItems.forEach((item, idx) => {
      rows.push([
        idx + 1,
        item.group_code,
        item.group_name,
        item.element_code,
        item.element_name,
        item.cfg_type,
        item.scaling_type,
        item.qty,
        fmtNumber(item.cfg_base, 3),
        fmtNumber(item.value, 3),
        fmtNumber(item.k_ands, 2),
        fmtNumber(item.k_test, 2),
        fmtNumber(item.k_doc, 2),
        fmtNumber(item.cfg_intermediate, 3),
        fmtNumber(item.eff_cfg, 3),
        fmtNumber(item.eff_ands, 3),
        fmtNumber(item.eff_test, 3),
        fmtNumber(item.eff_doc, 3),
        fmtNumber(item.eff_total, 3),
        item.has_unique_logic_flag ? '1' : '0',
        item.has_system_calculations_flag ? '1' : '0',
        item.is_individual ? '1' : '0',
        (item.comment || '').replace(/[\r\n]+/g, ' ')
      ]);
    });

    const csv = '\uFEFF' + rows.map(r => r.map(v => String(v).replace(/"/g, '""')).join(';')).join('\n');
    downloadFile('calc_detail.csv', csv, 'text/csv;charset=utf-8');
  }

  // === Снапшоты ===

  function collectMetaState() {
    return {
      projectName: document.getElementById('projectName').value || '',
      calcDate: document.getElementById('calcDate').value || '',
      calcVersion: document.getElementById('calcVersion').value || '',
      executor: document.getElementById('executor').value || '',
      customer: document.getElementById('customer').value || '',
      kPlatform: safeNumber(document.getElementById('kPlatformInput').value || 1, 1)
    };
  }

  function applyMetaState(meta) {
    document.getElementById('projectName').value = meta.projectName || '';
    document.getElementById('calcDate').value = meta.calcDate || '';
    document.getElementById('calcVersion').value = meta.calcVersion || '';
    document.getElementById('executor').value = meta.executor || '';
    document.getElementById('customer').value = meta.customer || '';
    document.getElementById('kPlatformInput').value = meta.kPlatform != null ? meta.kPlatform : 1;
  }

  function saveSnapshot() {
    const snapshot = {
      meta: collectMetaState(),
      methodologyRows,
      calcItems,
      nextItemId
    };
    const json = JSON.stringify(snapshot, null, 2);
    downloadFile('calc_snapshot.json', json, 'application/json;charset=utf-8');
  }

  function handleSnapshotUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const json = JSON.parse(e.target.result);
        if (!json || typeof json !== 'object') {
          alert('Некорректный формат снапшота.');
          return;
        }
        if (!Array.isArray(json.methodologyRows) || !Array.isArray(json.calcItems)) {
          alert('В снапшоте отсутствуют необходимые данные.');
          return;
        }

        methodologyRows = json.methodologyRows;
        calcItems = json.calcItems;
        nextItemId = json.nextItemId || (calcItems.reduce((max, it) => Math.max(max, it.id || 0), 0) + 1);

        buildGroupsFromMethodology();
        hasMethodology = true;
        onMethodologyLoaded();

        applyMetaState(json.meta || {});
    renderCalcTable();
    recalcGroupStats();
    document.getElementById('rowsSummaryBadge').textContent = 'Строк: ' + calcItems.length;

    document.getElementById('methodStatusBadge').textContent = 'Методика загружена (из снапшота)';
    methodFileName = file.name || 'Снапшот';
    document.getElementById('methodSuccessHint').style.display = 'block';
    updateMethodTitle();
    document.getElementById('kPlatformInput').disabled = false;
    document.getElementById('openMethodologyBtn').disabled = false;
    document.getElementById('toggleShowCodes').disabled = false;
    document.getElementById('exportDetailCsvBtn').disabled = false;
    document.getElementById('saveSnapshotBtn').disabled = false;
    document.getElementById('loadSnapshotBtn').disabled = false;
  } catch (err) {
    console.error(err);
    alert('Ошибка при чтении снапшота: ' + err.message);
  } finally {
    event.target.value = '';
  }
};
reader.readAsText(file, 'utf-8');

} </script>

</body>
</html>
